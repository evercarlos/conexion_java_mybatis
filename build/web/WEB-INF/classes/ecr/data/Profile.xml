<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Documento">
    <resultMap id="DocumentoMap" type="Documento">
        <result property="id" column="docu_id" />        
        <result property="titulo" column="docu_titulo" />
        <result property="resumen" column="docu_resumen"  />
        <result property="descripcion" column="docu_descripcion"  />
        <result property="fechaDocx" column="docu_fecha_docx" />   
        <result property="docuFecha" column="docu_fecha" />   
        <result property="tidoId" column="tido_id" />    
        <result property="mimeTypes" column="docu_mime_types" />    
        <result property="origenArchivo" column="docu_origen_archivo" />        
        <result property="estado" column="docu_estado"/>
        <result property="activo" column="docu_activo"/>
        <result property="metaData" column="docu_metadata" javaType="String"/>
        <result property="cataId" column="cata_id" />
        <result property="cateId" column="cate_id" />
        <result property="ruta" column="docu_ruta" />   
        <result property="privado" column="docu_privado" />   
        <result property="publico" column="docu_publico" />   
        <result property="propietario" column="propietario" />   
        <result property="personalizado" column="personalizado" />   
        <result property="remain" column="remain" />
        <result property="tituloMin" column="docu_mini_titulo" />
        <result property="resumenMin" column="docu_mini_resumen"  />
        <result property="usuaId" column="usua_id"  />
        <result property="docuHora" column="docu_hora"  />
        
        
        
      
      
    </resultMap>
   
    
    <resultMap id="AnhoMap" type="Anho">
        <result property="anho" column="anho" />
        <result property="mes" column="mes" />
    </resultMap>
    
    <select id="getCantidad" parameterType="HashMap" resultType="Integer">
        select count(documento.docu_id)::integer from documento
        left join mine_type on documento.docu_mime_types = mine_type.mine_nombre
        left join documento_etiqueta on documento_etiqueta.docu_id = documento.docu_id
        left join etiqueta on etiqueta.etiq_id = documento_etiqueta.etiq_id
        left join tipo_documento on documento.tido_id = tipo_documento.tido_id
        left join categoria on categoria.cate_id = documento.cate_id
        where (documento.docu_estado = true and docu_publico = true and docu_fecha_docx !='')  ${c}
    </select>
    
    <select id="getAdjuntos" resultMap="DocumentoMap" parameterType="HashMap">
        select *, (now() - documento.docu_hora) remain from documento
        left join mine_type on documento.docu_mime_types = mine_type.mine_nombre
        left join documento_etiqueta on documento_etiqueta.docu_id = documento.docu_id
        left join etiqueta on etiqueta.etiq_id = documento_etiqueta.etiq_id
        left join tipo_documento on documento.tido_id = tipo_documento.tido_id
        left join categoria on categoria.cate_id = documento.cate_id
        where docu_group = #{docuGroup}
        order by documento.docu_fecha desc, documento.docu_hora desc
    </select>
    
    <select id="getListDocumentos" resultMap="DocumentoMap" parameterType="HashMap">
        select *, (#{date} - documento.docu_hora) remain from documento
        left join mine_type on documento.docu_mime_types = mine_type.mine_nombre
        left join documento_etiqueta on documento_etiqueta.docu_id = documento.docu_id
        left join etiqueta on etiqueta.etiq_id = documento_etiqueta.etiq_id
        left join tipo_documento on documento.tido_id = tipo_documento.tido_id
        left join categoria on categoria.cate_id = documento.cate_id
        where documento.docu_estado = true ${c}
        order by documento.docu_fecha desc, documento.docu_hora desc
        limit ${limit} offset ${offset}
    </select>
    
    <select id="getListArchivos" resultMap="DocumentoMap" parameterType="HashMap">
        select * from documento
        left join mine_type on documento.docu_mime_types = mine_type.mine_nombre
        left join documento_etiqueta on documento_etiqueta.docu_id = documento.docu_id
        left join etiqueta on etiqueta.etiq_id = documento_etiqueta.etiq_id
        where documento.docu_ruta = #{ruta} ${filtro}
        order by cast(documento.docu_fecha_docx as date) desc, documento.docu_titulo desc
    </select>
    
    <select id="getOne" resultMap="DocumentoMap" parameterType="HashMap">
        select *, (now() - documento.docu_hora) remain from documento
        left join mine_type on documento.docu_mime_types = mine_type.mine_nombre
        left join documento_etiqueta on documento_etiqueta.docu_id = documento.docu_id
        left join etiqueta on etiqueta.etiq_id = documento_etiqueta.etiq_id
        left join tipo_documento on documento.tido_id = tipo_documento.tido_id
        left join categoria on categoria.cate_id = documento.cate_id
        where documento.docu_id = #{id}
        order by documento.docu_fecha desc, documento.docu_hora desc
        
        
    </select>
    
    <select id="getMaxId" resultType="Integer">
        select case when max(docu_id) is null then '0' else max(docu_id) end id from documento;
    </select>
    
    
    <insert id="insert" parameterType="Documento">
        <selectKey keyProperty="id" resultType="Integer" order="BEFORE">
            select case when max(docu_id) is null then '1' else max(docu_id)+1 end id 
            from documento
        </selectKey>
        INSERT INTO documento(
        docu_id, usua_id, docu_titulo, docu_resumen, docu_privado, docu_publico, 
        tido_id, docu_estado,  cata_id,  docu_origen_archivo, 
        docu_mime_types, cate_id, docu_fecha_docx, docu_data, tido_version, 
        docu_metadata, docu_ruta, propietario, personalizado,  docu_mini_titulo, docu_mini_resumen)
        VALUES (#{id}, #{usuaId}, #{titulo}, #{resumen}, #{privado}, #{publico}, 
        #{tidoId}, true,  #{cataId},  #{origen}, 
        #{mimeTypes}, #{cateId}, #{fechaDocx}, '', 0, #{metaData}, #{ruta}, #{propietario}, #{personalizado}, #{tituloMin},  #{resumenMin} );
    </insert>
    
    <delete id="delete"  parameterType="Integer">
        delete from documento
        where docu_id = #{id}
    </delete>
    
    <delete id="deletePropiedad"  parameterType="Documento">
        delete from documento_usuario
        where docu_id = #{id}
    </delete>
    
    
    
    <select id="getDocumento" parameterType="Integer" resultMap="DocumentoMap">
        select * from documento 
        left join mine_type on documento.docu_mime_types = mine_type.mine_nombre
        where (documento.docu_id = #{id})
    </select>
    
    <update id="update" parameterType="Documento" >
        UPDATE documento
        SET  docu_titulo=#{titulo}, docu_resumen=#{resumen}, tido_id=#{tidoId}, 
        docu_mini_titulo=#{tituloMin}, docu_mini_resumen=#{resumenMin},
        docu_fecha_docx=#{fechaDocx}, docu_metadata = #{metaData}, cate_id= #{cateId},
        docu_privado=#{privado}, docu_publico=#{publico}, personalizado = #{personalizado}
        WHERE docu_id = #{id}
    </update>
    
    <update id="updateRuta" parameterType="HashMap" >
        UPDATE documento
        SET  docu_ruta = #{ruta}, cata_id = #{cataId}
        WHERE docu_id = #{id}
    </update>
    
    <update id="updateRuta1" parameterType="HashMap" >
        UPDATE documento
        SET  docu_ruta=#{docuRuta}
        WHERE docu_id = #{id}
    </update>
    
  
    
    <select id="getListDocumentosXCatatalogo" resultMap="DocumentoMap" parameterType="HashMap">
        select * from documento
        where documento.docu_estado = true and cata_id=#{cataId} ${query}
    </select>
    
    <select id="getPersDocu" resultType="String" parameterType="HashMap">
        select * from documento_usuario
        where docu_id = #{idDocu}
    </select>
    
 
    
    <select id="getListDocs" resultMap="DocumentoMap" parameterType="HashMap">
        select * from documento
        left join documento_etiqueta on documento_etiqueta.docu_id = documento.docu_id
        left join etiqueta on etiqueta.etiq_id = documento_etiqueta.etiq_id
        left join tipo_documento on documento.tido_id = tipo_documento.tido_id
        where docu_estado = true  ${query}
    </select>
    
    <insert id="insertReport1" parameterType="HashMap">
        INSERT INTO tmp_report1(
        titulo, fecha, personal, tipo_documento)
        VALUES (#{titulo}, #{fecha}, #{nombre}, #{tipoDocumento});
    </insert>
    
    <update id="truncateReport1">
        truncate tmp_report1;
    </update>
    
    <select id="listaBoletas" resultMap="DocumentoMap"> 
        select * from documento t1
        where (docu_ruta is null or docu_ruta = '')
        order by docu_id asc 
    </select>
    
    <select id="listarSolo" resultMap="DocumentoMap" parameterType="HashMap"> 
        select * from documento 
        where docu_estado = true ${query1}
        order by docu_id asc 
    </select>
    
    
    <select id="getListAnho" parameterType="HashMap" resultMap="AnhoMap"> 
        select 
        distinct(trim(substring(docu_fecha_docx from 7)))::character(4) anho from documento 
        inner join documento_etiqueta on documento_etiqueta.docu_id = documento.docu_id
        where (documento.docu_estado = true and docu_publico = true and docu_fecha_docx !='')  ${q}
        order by anho desc 
    </select>
    
    <select id="getListAnhoCate" parameterType="HashMap" resultMap="AnhoMap">
        select 
        distinct(trim(substring(docu_fecha_docx from 7)))::character(4) anho from documento 
        inner join documento_etiqueta on documento_etiqueta.docu_id = documento.docu_id
        where (documento.docu_estado = true and docu_publico = true and docu_fecha_docx !='' and documento_etiqueta.etiq_id=#{etiq_id})
        order by anho desc 
    </select>
    
    <select id="getListMes" parameterType="HashMap" resultMap="AnhoMap"> 
        select 
        distinct(trim(substring(docu_fecha_docx from 4)))::character(2) mes from documento 
        inner join documento_etiqueta on documento_etiqueta.docu_id = documento.docu_id
        where (documento.docu_estado = true and docu_publico = true and docu_fecha_docx !='')  ${q}
        order by mes desc 
    </select>
    
    <select id="getListDocumentosWeb" resultMap="DocumentoMap" parameterType="HashMap">
        select * from documento
        left join mine_type on documento.docu_mime_types = mine_type.mine_nombre
        left join documento_etiqueta on documento_etiqueta.docu_id = documento.docu_id
        left join etiqueta on etiqueta.etiq_id = documento_etiqueta.etiq_id
        left join tipo_documento on documento.tido_id = tipo_documento.tido_id
        left join categoria on categoria.cate_id = documento.cate_id
        where (documento.docu_estado = true and docu_publico = true and docu_fecha_docx !='')  ${q}
        order by cast(documento.docu_fecha_docx as date) desc, documento.docu_hora desc
    </select>
    
   
    
    <select id="getListDocumentosWeb1" resultMap="DocumentoMap" parameterType="HashMap">
        select * from documento
        left join mine_type on documento.docu_mime_types = mine_type.mine_nombre
        left join documento_etiqueta on documento_etiqueta.docu_id = documento.docu_id
        left join etiqueta on etiqueta.etiq_id = documento_etiqueta.etiq_id
        left join tipo_documento on documento.tido_id = tipo_documento.tido_id
        left join categoria on categoria.cate_id = documento.cate_id
        where (documento.docu_estado = true and docu_publico = true and docu_fecha_docx !='')  ${q}
        ${order}
        limit ${limit} offset ${start}
    </select>
    
    <select id="getActualizacion" parameterType="HashMap" resultType="java.util.Date"> 
        select 
        max(docu_fecha) from documento 
        inner join documento_etiqueta on documento_etiqueta.docu_id = documento.docu_id
        where (documento.docu_estado = true and docu_publico = true and docu_fecha_docx !='')  and documento_etiqueta.etiq_id = #{etiqId}
       
        
    </select>
    
</mapper>

